# name: Build and Deploy
# on: [push]
# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout ğŸ›ï¸
#         uses: actions/checkout@v2.3.1

#       - name: Install and Build ğŸ”§ # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
#         run: |
#           npm install
#           npm run docs:build

#       - name: Deploy ğŸš€
#         uses: JamesIves/github-pages-deploy-action@4.1.4
#         with:
#           branch: gh-pages # The branch the action should deploy to.
#           folder: docs/.vitepress/dist # The folder the action should deploy.

name: docs

on:
  [push]
  # æ¯å½“ push åˆ° main åˆ†æ”¯æ—¶è§¦å‘éƒ¨ç½²
  # push:
  #branches: [main]
  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  # workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          # â€œæœ€è¿‘æ›´æ–°æ—¶é—´â€ ç­‰ git æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œéœ€è¦æ‹‰å–å…¨éƒ¨æäº¤è®°å½•
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          # é€‰æ‹©è¦ä½¿ç”¨çš„ node ç‰ˆæœ¬
          node-version: "16"

      # ç¼“å­˜ node_modules
      - name: Cache dependencies
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # å¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œå®‰è£…ä¾èµ–
      - name: Install dependencies
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn --frozen-lockfile

      # è¿è¡Œæ„å»ºè„šæœ¬
      - name: Build VuePress site
        run: yarn docs:build

      # # æŸ¥çœ‹ workflow çš„æ–‡æ¡£æ¥è·å–æ›´å¤šä¿¡æ¯
      # # @see https://github.com/crazy-max/ghaction-github-pages
      # - name: Deploy to GitHub Pages
      #   uses: crazy-max/ghaction-github-pages@v2
      #   with:
      #     # éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      #     target_branch: gh-pages
      #     # éƒ¨ç½²ç›®å½•ä¸º VuePress çš„é»˜è®¤è¾“å‡ºç›®å½•
      #     build_dir: docs/.vitepress/dist
      #   env:
      #     # @see https://docs.github.com/cn/actions/reference/authentication-in-a-workflow#about-the-github_token-secret
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          ARGS: "-avzr --delete"
          SOURCE: "docs/.vitepress/dist/"
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: "root"
          TARGET: "/home/blog"
